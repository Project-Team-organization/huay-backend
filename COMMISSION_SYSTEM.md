# ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô Master

## üìã ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°

‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Master ‡πÅ‡∏ö‡∏ö Real-time ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å-‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ cronjob

## üéØ ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

### ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô:
- **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å**: Master ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏ï‡∏≤‡∏° % ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô**: Master ‡πÄ‡∏™‡∏µ‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏ï‡∏≤‡∏° % ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- **‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥**: ‡∏ù‡∏≤‡∏Å - ‡∏ñ‡∏≠‡∏ô = ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
- **‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥**: ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏à‡∏≤‡∏Å‡∏ù‡∏≤‡∏Å - ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏à‡∏≤‡∏Å‡∏ñ‡∏≠‡∏ô

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
```
Master A ‡∏°‡∏µ commission 10%

1. User ‡∏ù‡∏≤‡∏Å 10,000 ‡∏ö‡∏≤‡∏ó
   - ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: 9,000 ‡∏ö‡∏≤‡∏ó (90%)
   - Master ‡πÑ‡∏î‡πâ: 1,000 ‡∏ö‡∏≤‡∏ó (10%)

2. User ‡∏ñ‡∏≠‡∏ô 6,000 ‡∏ö‡∏≤‡∏ó
   - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢: 5,400 ‡∏ö‡∏≤‡∏ó (90%)
   - Master ‡πÄ‡∏™‡∏µ‡∏¢: 600 ‡∏ö‡∏≤‡∏ó (10%)

3. ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: 10,000 - 6,000 = 4,000 ‡∏ö‡∏≤‡∏ó
   - ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: 3,600 ‡∏ö‡∏≤‡∏ó (90%)
   - Master ‡πÑ‡∏î‡πâ: 400 ‡∏ö‡∏≤‡∏ó (10%)
```

## üìä ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

### 1. Credit (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå:
- `master_id`: ObjectId - ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á Master
- `commission_percentage`: Number - % ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø
- `commission_amount`: Number - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø
- `system_profit`: Number - ‡∏Å‡∏≥‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ

### 2. Withdrawal (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå:
- `master_id`: ObjectId - ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á Master
- `commission_percentage`: Number - % ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø
- `commission_amount`: Number - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø (‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
- `system_loss`: Number - ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢

### 3. MasterCommission (‡πÉ‡∏´‡∏°‡πà)
‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:
- `master_id`: ObjectId - ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á Master
- `year`: Number - ‡∏õ‡∏µ
- `month`: Number - ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (1-12)
- `total_deposit_amount`: Number - ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏°
- `total_deposit_commission`: Number - ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏à‡∏≤‡∏Å‡∏ù‡∏≤‡∏Å
- `total_withdrawal_amount`: Number - ‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô‡∏£‡∏ß‡∏°
- `total_withdrawal_commission`: Number - ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏à‡∏≤‡∏Å‡∏ñ‡∏≠‡∏ô
- `net_amount`: Number - ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ù‡∏≤‡∏Å - ‡∏ñ‡∏≠‡∏ô)
- `net_commission`: Number - ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
- `status`: String - 'active', 'closed', 'paid'

## üîß API Endpoints

### 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á Master
```
GET /api/commission/master/:master_id
Query: ?year=2025&month=1
```

### 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
```
GET /api/commission/master/:master_id/current
```

### 3. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Admin)
```
GET /api/commission/all
Query: ?page=1&perPage=10&year=2025&month=1&status=active&master_id=xxx
```

### 4. ‡∏õ‡∏¥‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô
```
PUT /api/commission/close/:master_id
Body: { year: 2025, month: 1 }
```

### 5. ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô
```
PUT /api/commission/pay/:commission_id
```

## üìù ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### 1. ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
```javascript
GET /api/commission/master/507f1f77bcf86cd799439011/current

Response:
{
  "success": true,
  "message": "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
  "data": {
    "_id": "...",
    "master_id": {
      "_id": "507f1f77bcf86cd799439011",
      "username": "master01",
      "commission_percentage": 10
    },
    "year": 2025,
    "month": 1,
    "total_deposit_amount": 100000,
    "total_deposit_count": 10,
    "total_deposit_commission": 10000,
    "total_withdrawal_amount": 60000,
    "total_withdrawal_count": 5,
    "total_withdrawal_commission": -6000,
    "net_amount": 40000,
    "net_commission": 4000,
    "status": "active"
  }
}
```

### 2. ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
```javascript
GET /api/commission/master/507f1f77bcf86cd799439011?year=2024

Response:
{
  "success": true,
  "data": [
    {
      "year": 2024,
      "month": 12,
      "net_commission": 5000,
      "status": "paid"
    },
    {
      "year": 2024,
      "month": 11,
      "net_commission": 3500,
      "status": "paid"
    }
  ]
}
```

## üîÑ ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å (Credit):
1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏à‡∏≤‡∏Å `commission_percentage` ‡∏Ç‡∏≠‡∏á Master
2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á `Credit` ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø
3. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó `MasterCommission` ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Real-time)

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô (Withdrawal):
1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏à‡∏≤‡∏Å `commission_percentage` ‡∏Ç‡∏≠‡∏á Master
2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á `Withdrawal` ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø
3. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó `MasterCommission` ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Real-time)

## üí° ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ

1. **Real-time**: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ transaction
2. **Accurate**: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å transaction ‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£
3. **Audit Trail**: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å transaction
4. **No Cronjob**: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ cronjob ‡∏£‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô
5. **Atomic**: ‡πÉ‡∏ä‡πâ `$inc` ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏à‡∏≤‡∏Å race condition

## üé® ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á MasterCommission

- **active**: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∞‡∏™‡∏°‡∏≠‡∏¢‡∏π‡πà
- **closed**: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
- **paid**: ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß

## üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏

- ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å `netAmount` (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å fee)
- ‡∏ñ‡πâ‡∏≤ User ‡πÑ‡∏°‡πà‡∏°‡∏µ Master ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø
- ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö Master ‡∏Å‡πá‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢ (‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°)
- % ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏Ø ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ ‡∏ì ‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏ó‡∏≥ transaction (‡∏ñ‡πâ‡∏≤ Master ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô % ‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö transaction ‡πÄ‡∏Å‡πà‡∏≤)
