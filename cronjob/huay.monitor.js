const cron = require('node-cron');
const mongoose = require('mongoose');
const {
    huaylaocronjob,
    huaylaoextracronjob,
    huaylaostarcronjob,
    huaylaounioncronjob,
    huaylaohd,
    huaylaovip,
    huaylaostarvip,
    huylaogachad,
    huaylaothakhek5d,
    huaylaothakhekvip,
    huaylaotv
} = require('../service/cronjob/cronjob.service');

// Import models ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
const LotteryLao = require('../models/lotterylao.model');
const LotteryLaoExtra = require('../models/lotterylao.extra.model');
const LotteryLaoStars = require('../models/lotterylao.stars.model');
const LotteryLaoUnion = require('../models/lotterylao.union.model');
const LotteryLaoHd = require('../models/lottery_lao_hd.model');
const LotteryLaoVip = require('../models/lottery_lao_vip.model');
const LotteryLaoStarsVip = require('../models/lottery_lao_stars_vip.model');
const LotteryLaoRedcross = require('../models/lottery_lao_redcross.model');
const LotteryLaoThakhek5d = require('../models/lottery_lao_thakhek_5d.model');
const LotteryLaoThakhekVip = require('../models/lottery_lao_thakhek_vip.model');
const LotteryLaoTv = require('../models/lottery_lao_tv.model');

// Function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏ß‡πà‡∏≤‡∏°‡∏µ "xxx" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
const checkIncompleteResults = (results) => {
    if (!results || typeof results !== 'object') return false;
    
    return Object.values(results).some(value => {
        if (typeof value === 'string') {
            return value.includes('xxx') || value.includes('xx') || value === "" || value === null || value === undefined;
        }
        return value === null || value === undefined;
    });
};

// Function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
const checkLaoLotteryData = async () => {
    console.log(`\nüîç [${new Date().toLocaleString("th-TH", { timeZone: "Asia/Bangkok" })}] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß...`);
    
    const now = new Date();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏´‡∏•‡∏±‡∏á 23:00)
    const isNightTime = now.getHours() >= 23;
    
    const incompleteLotteries = [];
    
    try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏û‡∏±‡∏í‡∏ô‡∏≤
        const laoData = await LotteryLao.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoData && checkIncompleteResults(laoData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏û‡∏±‡∏í‡∏ô‡∏≤',
                function: huaylaocronjob,
                data: laoData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß Extra
        const laoExtraData = await LotteryLaoExtra.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoExtraData && checkIncompleteResults(laoExtraData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß Extra',
                function: huaylaoextracronjob,
                data: laoExtraData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏™‡∏ï‡∏≤‡∏£‡πå
        const laoStarsData = await LotteryLaoStars.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoStarsData && checkIncompleteResults(laoStarsData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏™‡∏ï‡∏≤‡∏£‡πå',
                function: huaylaostarcronjob,
                data: laoStarsData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ
        const laoUnionData = await LotteryLaoUnion.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoUnionData && checkIncompleteResults(laoUnionData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ',
                function: huaylaounioncronjob,
                data: laoUnionData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß HD
        const laoHdData = await LotteryLaoHd.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoHdData && checkIncompleteResults(laoHdData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß HD',
                function: huaylaohd,
                data: laoHdData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß VIP
        const laoVipData = await LotteryLaoVip.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoVipData && checkIncompleteResults(laoVipData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß VIP',
                function: huaylaovip,
                data: laoVipData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏™‡∏ï‡∏≤‡∏£‡πå VIP
        const laoStarsVipData = await LotteryLaoStarsVip.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoStarsVipData && checkIncompleteResults(laoStarsVipData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏™‡∏ï‡∏≤‡∏£‡πå VIP',
                function: huaylaostarvip,
                data: laoStarsVipData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏Å‡∏≤‡∏ä‡∏≤‡∏î
        const laoRedcrossData = await LotteryLaoRedcross.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoRedcrossData && checkIncompleteResults(laoRedcrossData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏Å‡∏≤‡∏ä‡∏≤‡∏î',
                function: huylaogachad,
                data: laoRedcrossData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏ó‡πà‡∏≤‡πÅ‡∏Ç‡∏Å 5D
        const laoThakhek5dData = await LotteryLaoThakhek5d.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoThakhek5dData && checkIncompleteResults(laoThakhek5dData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏ó‡πà‡∏≤‡πÅ‡∏Ç‡∏Å 5D',
                function: huaylaothakhek5d,
                data: laoThakhek5dData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏ó‡πà‡∏≤‡πÅ‡∏Ç‡∏Å VIP
        const laoThakhekVipData = await LotteryLaoThakhekVip.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoThakhekVipData && checkIncompleteResults(laoThakhekVipData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏ó‡πà‡∏≤‡πÅ‡∏Ç‡∏Å VIP',
                function: huaylaothakhekvip,
                data: laoThakhekVipData
            });
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß TV
        const laoTvData = await LotteryLaoTv.findOne({ 
            createdAt: { $gte: today } 
        }).sort({ createdAt: -1 });
        
        if (laoTvData && checkIncompleteResults(laoTvData.results)) {
            incompleteLotteries.push({
                name: '‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß TV',
                function: huaylaotv,
                data: laoTvData
            });
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
        if (incompleteLotteries.length > 0) {
            console.log(`‚ö†Ô∏è  ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ${incompleteLotteries.length} ‡∏ï‡∏±‡∏ß:`);
            incompleteLotteries.forEach((lottery, index) => {
                console.log(`   ${index + 1}. ${lottery.name}`);
                console.log(`      üìä ‡∏ú‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:`, JSON.stringify(lottery.data.results, null, 6));
            });
            
            // ‡∏¢‡∏¥‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
            if (isNightTime) {
                console.log(`\nüåô ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô (‡∏´‡∏•‡∏±‡∏á 23:00) - ‡∏¢‡∏¥‡∏á function ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß...`);
            } else {
                console.log(`\nüîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏¥‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô...`);
            }
            
            for (const lottery of incompleteLotteries) {
                try {
                    if (isNightTime) {
                        console.log(`\nüåô ‡∏¢‡∏¥‡∏á function ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á ${lottery.name}...`);
                    } else {
                        console.log(`\nüì° ‡∏¢‡∏¥‡∏á‡πÄ‡∏ä‡πá‡∏Ñ ${lottery.name}...`);
                    }
                    
                    await lottery.function();
                    
                    if (isNightTime) {
                        console.log(`‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á function ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á ${lottery.name}`);
                    } else {
                        console.log(`‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ ${lottery.name}`);
                    }
                } catch (error) {
                    if (isNightTime) {
                        console.error(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á function ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á ${lottery.name}:`, error.message);
                    } else {
                        console.error(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ ${lottery.name}:`, error.message);
                    }
                }
            }
            
        } else {
            console.log(`‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß!`);
        }
        
    } catch (error) {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß:', error.message);
    }
};

// ===== CRONJOB ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß =====

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ß‡∏¢‡∏•‡∏≤‡∏ß‡∏ó‡∏∏‡∏Å‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡∏•‡∏≠‡∏î 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
cron.schedule('* * * * *', async () => {
    console.log(`\nüîç [${new Date().toLocaleString("th-TH", { timeZone: "Asia/Bangkok" })}] Monitor - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏ô‡∏≤‡∏ó‡∏µ`);
    await checkLaoLotteryData();
}, { timezone: "Asia/Bangkok" });

console.log('üöÄ Lao Lottery Monitor Cronjob Started!');
console.log('üìÖ Schedule: ‡∏ó‡∏∏‡∏Å‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡∏•‡∏≠‡∏î 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á');
